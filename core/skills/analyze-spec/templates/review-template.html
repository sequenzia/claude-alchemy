<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Spec Analysis Review</title>
<style>
  *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

  :root {
    --bg: #0d1117;
    --bg-surface: #161b22;
    --bg-elevated: #1c2128;
    --border: #30363d;
    --border-active: #58a6ff;
    --text: #e6edf3;
    --text-muted: #8b949e;
    --text-heading: #f0f6fc;
    --amber: #d29922;
    --amber-bg: rgba(210, 153, 34, 0.12);
    --green: #3fb950;
    --green-bg: rgba(63, 185, 80, 0.12);
    --red: #f85149;
    --red-bg: rgba(248, 81, 73, 0.12);
    --purple: #bc8cff;
    --purple-bg: rgba(188, 140, 255, 0.12);
    --blue: #58a6ff;
    --blue-bg: rgba(88, 166, 255, 0.12);
  }

  body {
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica, Arial, sans-serif;
    background: var(--bg);
    color: var(--text);
    line-height: 1.6;
    min-height: 100vh;
  }

  /* Header */
  .header {
    background: var(--bg-surface);
    border-bottom: 1px solid var(--border);
    padding: 16px 24px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    flex-wrap: wrap;
    gap: 12px;
  }
  .header-left { display: flex; align-items: center; gap: 16px; }
  .header h1 { font-size: 18px; color: var(--text-heading); font-weight: 600; }
  .header-meta { display: flex; gap: 16px; font-size: 13px; color: var(--text-muted); }
  .header-meta span { display: flex; align-items: center; gap: 4px; }

  /* Dashboard */
  .dashboard {
    background: var(--bg-surface);
    border-bottom: 1px solid var(--border);
    padding: 16px 24px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    flex-wrap: wrap;
    gap: 16px;
  }
  .stats { display: flex; gap: 24px; }
  .stat {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 2px;
  }
  .stat-value { font-size: 24px; font-weight: 700; }
  .stat-label { font-size: 11px; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.5px; }
  .stat-bar {
    width: 100%;
    height: 4px;
    background: var(--border);
    border-radius: 2px;
    margin-top: 4px;
    overflow: hidden;
  }
  .stat-bar-fill { height: 100%; border-radius: 2px; transition: width 0.3s; }

  /* Filter bar */
  .filters { display: flex; gap: 8px; align-items: center; flex-wrap: wrap; }
  .filter-tabs { display: flex; gap: 2px; background: var(--bg); border-radius: 6px; padding: 2px; }
  .filter-tab {
    padding: 6px 14px;
    border: none;
    background: transparent;
    color: var(--text-muted);
    font-size: 13px;
    cursor: pointer;
    border-radius: 4px;
    transition: all 0.15s;
    font-family: inherit;
  }
  .filter-tab:hover { color: var(--text); }
  .filter-tab.active { background: var(--bg-elevated); color: var(--text); }
  .filter-tab .count {
    display: inline-block;
    margin-left: 4px;
    font-size: 11px;
    background: var(--border);
    padding: 0 6px;
    border-radius: 10px;
  }

  select.severity-filter {
    background: var(--bg);
    color: var(--text);
    border: 1px solid var(--border);
    padding: 6px 28px 6px 10px;
    border-radius: 6px;
    font-size: 13px;
    cursor: pointer;
    font-family: inherit;
    appearance: none;
    background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%238b949e' d='M6 8L1 3h10z'/%3E%3C/svg%3E");
    background-repeat: no-repeat;
    background-position: right 8px center;
  }

  /* Main layout */
  .main { display: flex; height: calc(100vh - 140px); overflow: hidden; }

  /* Left panel — spec content */
  .spec-panel {
    flex: 6;
    overflow-y: auto;
    padding: 24px;
    border-right: 1px solid var(--border);
  }
  .spec-content {
    font-family: "SFMono-Regular", Consolas, "Liberation Mono", Menlo, monospace;
    font-size: 13px;
    line-height: 1.8;
    white-space: pre-wrap;
    word-wrap: break-word;
  }
  .spec-content h1, .spec-content h2, .spec-content h3, .spec-content h4 {
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica, Arial, sans-serif;
    color: var(--text-heading);
    margin: 20px 0 8px;
    line-height: 1.3;
  }
  .spec-content h1 { font-size: 22px; border-bottom: 1px solid var(--border); padding-bottom: 8px; }
  .spec-content h2 { font-size: 18px; }
  .spec-content h3 { font-size: 15px; }
  .spec-content h4 { font-size: 14px; }
  .spec-content strong { color: var(--text-heading); }
  .spec-content code {
    background: var(--bg-elevated);
    padding: 2px 6px;
    border-radius: 3px;
    font-size: 12px;
  }
  .spec-content ul, .spec-content ol { padding-left: 24px; margin: 4px 0; }
  .spec-content li { margin: 2px 0; }

  /* Annotated section */
  .annotated-line {
    border-left: 3px solid transparent;
    padding-left: 8px;
    margin-left: -11px;
    cursor: pointer;
    transition: background 0.15s;
    border-radius: 0 4px 4px 0;
  }
  .annotated-line:hover { background: var(--bg-elevated); }
  .annotated-line.severity-warning { border-left-color: var(--amber); }
  .annotated-line.severity-critical { border-left-color: var(--purple); }
  .annotated-line.severity-suggestion { border-left-color: var(--blue); }
  .annotated-line.status-approved { border-left-color: var(--green); }
  .annotated-line.status-rejected { border-left-color: var(--red); }
  .annotated-line.selected { background: var(--bg-elevated); }

  .annotation-marker {
    display: inline-block;
    font-size: 10px;
    padding: 1px 6px;
    border-radius: 3px;
    margin-left: 8px;
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica, Arial, sans-serif;
    vertical-align: middle;
    cursor: pointer;
  }
  .annotation-marker.severity-warning { background: var(--amber-bg); color: var(--amber); }
  .annotation-marker.severity-critical { background: var(--purple-bg); color: var(--purple); }
  .annotation-marker.severity-suggestion { background: var(--blue-bg); color: var(--blue); }

  /* Editable blocks */
  [contenteditable="true"] {
    outline: none;
    border: 1px dashed transparent;
    padding: 2px 4px;
    margin: -2px -4px;
    border-radius: 3px;
    transition: border-color 0.15s;
  }
  [contenteditable="true"]:focus {
    border-color: var(--border-active);
    background: var(--bg-elevated);
  }

  /* Right panel — findings */
  .findings-panel {
    flex: 4;
    overflow-y: auto;
    padding: 16px;
    background: var(--bg-surface);
  }
  .findings-list { display: flex; flex-direction: column; gap: 8px; }

  .finding-card {
    background: var(--bg);
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 14px;
    cursor: pointer;
    transition: all 0.15s;
  }
  .finding-card:hover { border-color: var(--border-active); }
  .finding-card.selected { border-color: var(--border-active); box-shadow: 0 0 0 1px var(--border-active); }
  .finding-card.status-approved { border-left: 3px solid var(--green); }
  .finding-card.status-rejected { border-left: 3px solid var(--red); }

  .finding-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: 8px;
  }
  .finding-id { font-size: 11px; color: var(--text-muted); font-weight: 600; }
  .finding-title { font-size: 14px; font-weight: 600; color: var(--text-heading); margin-bottom: 4px; }

  .badge {
    display: inline-block;
    font-size: 11px;
    padding: 2px 8px;
    border-radius: 10px;
    font-weight: 500;
  }
  .badge-critical { background: var(--purple-bg); color: var(--purple); }
  .badge-warning { background: var(--amber-bg); color: var(--amber); }
  .badge-suggestion { background: var(--blue-bg); color: var(--blue); }

  .category-badge {
    font-size: 11px;
    color: var(--text-muted);
    margin-bottom: 6px;
  }

  .finding-issue {
    font-size: 13px;
    color: var(--text-muted);
    margin-bottom: 10px;
    line-height: 1.5;
  }

  .finding-detail { margin-bottom: 10px; }
  .finding-detail-label {
    font-size: 11px;
    color: var(--text-muted);
    text-transform: uppercase;
    letter-spacing: 0.5px;
    margin-bottom: 4px;
  }
  .finding-detail-text {
    font-size: 13px;
    font-family: "SFMono-Regular", Consolas, "Liberation Mono", Menlo, monospace;
    background: var(--bg-elevated);
    padding: 8px 10px;
    border-radius: 4px;
    border: 1px solid var(--border);
    white-space: pre-wrap;
    word-wrap: break-word;
  }
  .finding-detail-text.current { border-left: 3px solid var(--red); }
  .finding-detail-text.proposed { border-left: 3px solid var(--green); }

  .finding-actions {
    display: flex;
    gap: 8px;
    margin-top: 12px;
    flex-wrap: wrap;
  }

  .btn {
    padding: 6px 14px;
    border: 1px solid var(--border);
    border-radius: 6px;
    font-size: 13px;
    cursor: pointer;
    font-family: inherit;
    font-weight: 500;
    transition: all 0.15s;
    background: var(--bg-elevated);
    color: var(--text);
  }
  .btn:hover { border-color: var(--text-muted); }
  .btn-approve { border-color: var(--green); color: var(--green); }
  .btn-approve:hover { background: var(--green-bg); }
  .btn-reject { border-color: var(--red); color: var(--red); }
  .btn-reject:hover { background: var(--red-bg); }
  .btn-primary { background: var(--blue); color: #fff; border-color: var(--blue); }
  .btn-primary:hover { opacity: 0.9; }

  .comment-area {
    width: 100%;
    background: var(--bg-elevated);
    border: 1px solid var(--border);
    border-radius: 6px;
    color: var(--text);
    padding: 8px 10px;
    font-size: 13px;
    font-family: inherit;
    resize: vertical;
    min-height: 60px;
    margin-top: 8px;
  }
  .comment-area:focus { outline: none; border-color: var(--border-active); }

  .status-badge {
    display: inline-block;
    font-size: 11px;
    padding: 2px 8px;
    border-radius: 10px;
    font-weight: 600;
  }
  .status-pending { background: var(--amber-bg); color: var(--amber); }
  .status-approved { background: var(--green-bg); color: var(--green); }
  .status-rejected { background: var(--red-bg); color: var(--red); }

  .finding-location {
    font-size: 11px;
    color: var(--text-muted);
    margin-bottom: 6px;
  }

  /* Prompt output panel */
  .prompt-panel {
    background: var(--bg-surface);
    border-top: 1px solid var(--border);
    padding: 16px 24px;
  }
  .prompt-panel.hidden { display: none; }
  .prompt-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 10px;
  }
  .prompt-header h3 { font-size: 14px; color: var(--text-heading); }
  .prompt-actions { display: flex; gap: 8px; }
  .prompt-content {
    background: var(--bg);
    border: 1px solid var(--border);
    border-radius: 6px;
    padding: 12px 14px;
    font-size: 13px;
    font-family: "SFMono-Regular", Consolas, "Liberation Mono", Menlo, monospace;
    white-space: pre-wrap;
    word-wrap: break-word;
    max-height: 200px;
    overflow-y: auto;
    line-height: 1.6;
  }

  /* Notification toast */
  .toast {
    position: fixed;
    bottom: 24px;
    right: 24px;
    background: var(--bg-elevated);
    border: 1px solid var(--green);
    color: var(--green);
    padding: 10px 18px;
    border-radius: 8px;
    font-size: 13px;
    z-index: 1000;
    opacity: 0;
    transform: translateY(10px);
    transition: all 0.2s;
    pointer-events: none;
  }
  .toast.show { opacity: 1; transform: translateY(0); }

  /* Empty state */
  .empty-state {
    text-align: center;
    padding: 60px 24px;
    color: var(--text-muted);
  }
  .empty-state h3 { font-size: 16px; margin-bottom: 8px; color: var(--text); }

  /* Responsive */
  @media (max-width: 900px) {
    .main { flex-direction: column; height: auto; }
    .spec-panel { border-right: none; border-bottom: 1px solid var(--border); max-height: 50vh; }
    .findings-panel { max-height: 50vh; }
  }
</style>
</head>
<body>

<!-- Header -->
<header class="header">
  <div class="header-left">
    <h1 id="spec-name"></h1>
  </div>
  <div class="header-meta">
    <span id="depth-level"></span>
    <span id="analyzed-at"></span>
  </div>
</header>

<!-- Dashboard -->
<div class="dashboard">
  <div class="stats" id="stats"></div>
  <div class="filters">
    <div class="filter-tabs" id="status-filters"></div>
    <select class="severity-filter" id="severity-filter">
      <option value="all">All Severities</option>
      <option value="critical">Critical</option>
      <option value="warning">Warning</option>
      <option value="suggestion">Suggestion</option>
    </select>
  </div>
</div>

<!-- Main content -->
<div class="main">
  <div class="spec-panel">
    <div class="spec-content" id="spec-content"></div>
  </div>
  <div class="findings-panel">
    <div class="findings-list" id="findings-list"></div>
  </div>
</div>

<!-- Prompt output -->
<div class="prompt-panel hidden" id="prompt-panel">
  <div class="prompt-header">
    <h3>Prompt from Approved Changes (<span id="approved-count">0</span>)</h3>
    <div class="prompt-actions">
      <button class="btn btn-primary" onclick="copyPrompt()">Copy Prompt</button>
      <button class="btn" onclick="downloadSpec()">Download Modified Spec</button>
    </div>
  </div>
  <div class="prompt-content" id="prompt-content"></div>
</div>

<!-- Toast -->
<div class="toast" id="toast"></div>

<script>
// === DATA INJECTION ===
const SPEC_CONTENT = /*__SPEC_CONTENT__*/ {};
const FINDINGS_DATA = /*__FINDINGS_DATA__*/ [];

// === STATE ===
const STATE = {
  findings: [],
  selectedId: null,
  statusFilter: 'all',
  severityFilter: 'all',
  comments: {}
};

function init() {
  STATE.findings = FINDINGS_DATA.map(f => ({
    ...f,
    status: f.status || 'pending'
  }));
  renderHeader();
  renderStats();
  renderFilters();
  renderSpec();
  renderFindings();
  updatePromptPanel();
}

// === RENDERING ===

function renderHeader() {
  document.getElementById('spec-name').textContent = SPEC_CONTENT.name || 'Spec Analysis';
  document.getElementById('depth-level').textContent = SPEC_CONTENT.depthLevel || '';
  document.getElementById('analyzed-at').textContent = SPEC_CONTENT.analyzedAt || '';
  document.title = `Review: ${SPEC_CONTENT.name || 'Spec Analysis'}`;
}

function renderStats() {
  const counts = { total: STATE.findings.length, critical: 0, warning: 0, suggestion: 0, pending: 0, approved: 0, rejected: 0 };
  STATE.findings.forEach(f => {
    counts[f.severity]++;
    counts[f.status]++;
  });

  const el = document.getElementById('stats');
  el.innerHTML = [
    statHTML('Total', counts.total, ''),
    statHTML('Critical', counts.critical, 'var(--purple)'),
    statHTML('Warning', counts.warning, 'var(--amber)'),
    statHTML('Suggestion', counts.suggestion, 'var(--blue)'),
    statHTML('Pending', counts.pending, 'var(--amber)'),
    statHTML('Approved', counts.approved, 'var(--green)'),
    statHTML('Rejected', counts.rejected, 'var(--red)')
  ].join('');
}

function statHTML(label, value, color) {
  const pct = STATE.findings.length ? (value / STATE.findings.length * 100) : 0;
  return `<div class="stat">
    <div class="stat-value" style="color:${color || 'var(--text)'}">${value}</div>
    <div class="stat-label">${label}</div>
    <div class="stat-bar"><div class="stat-bar-fill" style="width:${pct}%;background:${color || 'var(--border)'}"></div></div>
  </div>`;
}

function renderFilters() {
  const counts = { all: STATE.findings.length, pending: 0, approved: 0, rejected: 0 };
  STATE.findings.forEach(f => counts[f.status]++);

  const tabs = [
    { key: 'all', label: 'All' },
    { key: 'pending', label: 'Pending' },
    { key: 'approved', label: 'Approved' },
    { key: 'rejected', label: 'Rejected' }
  ];

  document.getElementById('status-filters').innerHTML = tabs.map(t =>
    `<button class="filter-tab${STATE.statusFilter === t.key ? ' active' : ''}"
      onclick="setStatusFilter('${t.key}')">${t.label}<span class="count">${counts[t.key]}</span></button>`
  ).join('');
}

function renderSpec() {
  const content = SPEC_CONTENT.content || '';
  const el = document.getElementById('spec-content');
  const lines = content.split('\n');
  const findingsByLine = {};
  STATE.findings.forEach(f => {
    if (f.lineNumber) {
      if (!findingsByLine[f.lineNumber]) findingsByLine[f.lineNumber] = [];
      findingsByLine[f.lineNumber].push(f);
    }
  });

  let html = '';
  lines.forEach((line, i) => {
    const lineNum = i + 1;
    const findings = findingsByLine[lineNum];
    if (findings) {
      const f = findings[0];
      const statusClass = f.status !== 'pending' ? ` status-${f.status}` : '';
      const selectedClass = f.id === STATE.selectedId ? ' selected' : '';
      const markers = findings.map(ff =>
        `<span class="annotation-marker severity-${ff.severity}" onclick="selectFinding('${ff.id}')" title="${escapeAttr(ff.title)}">${ff.id}</span>`
      ).join('');
      html += `<div class="annotated-line severity-${f.severity}${statusClass}${selectedClass}" data-finding-id="${f.id}" onclick="selectFinding('${f.id}')">${renderMarkdownLine(line)}${markers}</div>`;
    } else {
      html += `<div>${renderMarkdownLine(line)}</div>`;
    }
  });

  el.innerHTML = html;
}

function renderFindings() {
  const filtered = STATE.findings.filter(f => {
    if (STATE.statusFilter !== 'all' && f.status !== STATE.statusFilter) return false;
    if (STATE.severityFilter !== 'all' && f.severity !== STATE.severityFilter) return false;
    return true;
  });

  const el = document.getElementById('findings-list');

  if (filtered.length === 0) {
    el.innerHTML = `<div class="empty-state"><h3>No findings match filters</h3><p>Try changing the status or severity filter.</p></div>`;
    return;
  }

  el.innerHTML = filtered.map(f => {
    const isSelected = f.id === STATE.selectedId;
    const comment = STATE.comments[f.id] || '';
    return `
    <div class="finding-card${isSelected ? ' selected' : ''} status-${f.status}" onclick="selectFinding('${f.id}')">
      <div class="finding-header">
        <div>
          <span class="finding-id">${esc(f.id)}</span>
          <span class="badge badge-${f.severity}">${esc(f.severity)}</span>
          <span class="status-badge status-${f.status}">${esc(f.status)}</span>
        </div>
      </div>
      <div class="finding-title">${esc(f.title)}</div>
      <div class="category-badge">${esc(f.category)}</div>
      <div class="finding-location">${esc(f.location)}</div>
      <div class="finding-issue">${esc(f.issue)}</div>
      ${f.impact ? `<div class="finding-issue" style="font-style:italic">${esc(f.impact)}</div>` : ''}
      ${isSelected ? `
        ${f.currentText ? `
          <div class="finding-detail" onclick="event.stopPropagation()">
            <div class="finding-detail-label">Current</div>
            <div class="finding-detail-text current">${esc(f.currentText)}</div>
          </div>` : ''}
        ${f.proposedText ? `
          <div class="finding-detail" onclick="event.stopPropagation()">
            <div class="finding-detail-label">Proposed</div>
            <div class="finding-detail-text proposed">${esc(f.proposedText)}</div>
          </div>` : ''}
        <textarea class="comment-area" placeholder="Add a comment (optional)..." oninput="setComment('${f.id}', this.value)" onclick="event.stopPropagation()" onmousedown="event.stopPropagation()">${esc(comment)}</textarea>
        <div class="finding-actions">
          ${f.status === 'pending' ? `
            <button class="btn btn-approve" onclick="event.stopPropagation(); setStatus('${f.id}', 'approved')">Approve</button>
            <button class="btn btn-reject" onclick="event.stopPropagation(); setStatus('${f.id}', 'rejected')">Reject</button>
          ` : `
            <button class="btn" onclick="event.stopPropagation(); setStatus('${f.id}', 'pending')">Reset to Pending</button>
          `}
        </div>
      ` : ''}
    </div>`;
  }).join('');
}

// === MINIMAL MARKDOWN RENDERER ===

function renderMarkdownLine(line) {
  if (/^#### (.+)/.test(line)) return `<h4>${esc(RegExp.$1)}</h4>`;
  if (/^### (.+)/.test(line)) return `<h3>${esc(RegExp.$1)}</h3>`;
  if (/^## (.+)/.test(line)) return `<h2>${esc(RegExp.$1)}</h2>`;
  if (/^# (.+)/.test(line)) return `<h1>${esc(RegExp.$1)}</h1>`;
  if (/^[-*] (.+)/.test(line)) return `<li>${inlineMarkdown(RegExp.$1)}</li>`;
  if (/^\d+\. (.+)/.test(line)) return `<li>${inlineMarkdown(RegExp.$1)}</li>`;
  if (line.trim() === '') return '<br>';
  return inlineMarkdown(line);
}

function inlineMarkdown(text) {
  let s = esc(text);
  s = s.replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>');
  s = s.replace(/`(.+?)`/g, '<code>$1</code>');
  return s;
}

// === STATE MUTATIONS ===

function selectFinding(id) {
  STATE.selectedId = STATE.selectedId === id ? null : id;
  updateAll();
}

function setStatusFilter(filter) {
  STATE.statusFilter = filter;
  STATE.selectedId = null;
  updateAll();
}

function setStatus(id, status) {
  const f = STATE.findings.find(x => x.id === id);
  if (f) f.status = status;
  updateAll();
  showToast(`${id} ${status}`);
}

function setComment(id, text) {
  STATE.comments[id] = text;
}

function updateAll() {
  renderStats();
  renderFilters();
  renderSpec();
  renderFindings();
  updatePromptPanel();
}

// === PROMPT GENERATION ===

function updatePromptPanel() {
  const approved = STATE.findings.filter(f => f.status === 'approved');
  const panel = document.getElementById('prompt-panel');
  const countEl = document.getElementById('approved-count');

  countEl.textContent = approved.length;

  if (approved.length === 0) {
    panel.classList.add('hidden');
    return;
  }

  panel.classList.remove('hidden');

  const prompt = generatePrompt(approved);
  document.getElementById('prompt-content').textContent = prompt;
}

function generatePrompt(approved) {
  const lines = [`Apply these changes to the spec at: ${SPEC_CONTENT.path}\n`];

  approved.forEach((f, i) => {
    lines.push(`${i + 1}. ${f.title}`);
    lines.push(`   Location: ${f.location}`);
    if (f.currentText && f.proposedText) {
      lines.push(`   Change: "${f.currentText}" → "${f.proposedText}"`);
    } else if (f.proposedText) {
      lines.push(`   Add: "${f.proposedText}"`);
    } else {
      lines.push(`   Issue: ${f.issue}`);
    }
    const comment = STATE.comments[f.id];
    if (comment) {
      lines.push(`   Note: ${comment}`);
    }
    lines.push('');
  });

  return lines.join('\n');
}

function copyPrompt() {
  const approved = STATE.findings.filter(f => f.status === 'approved');
  const prompt = generatePrompt(approved);
  navigator.clipboard.writeText(prompt).then(() => {
    showToast('Prompt copied to clipboard');
  }).catch(() => {
    const el = document.getElementById('prompt-content');
    const range = document.createRange();
    range.selectNodeContents(el);
    window.getSelection().removeAllRanges();
    window.getSelection().addRange(range);
    showToast('Select All applied — press Cmd/Ctrl+C');
  });
}

function downloadSpec() {
  const content = SPEC_CONTENT.content || '';
  let modified = content;

  const approved = STATE.findings.filter(f => f.status === 'approved' && f.currentText && f.proposedText);
  approved.forEach(f => {
    modified = modified.replace(f.currentText, f.proposedText);
  });

  const blob = new Blob([modified], { type: 'text/markdown' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  const baseName = (SPEC_CONTENT.path || 'spec').split('/').pop().replace(/\.md$/, '');
  a.download = `${baseName}.modified.md`;
  a.click();
  URL.revokeObjectURL(url);
  showToast('Modified spec downloaded');
}

// === HELPERS ===

function esc(str) {
  if (!str) return '';
  const d = document.createElement('div');
  d.textContent = String(str);
  return d.innerHTML;
}

function escapeAttr(str) {
  return esc(str).replace(/"/g, '&quot;');
}

function showToast(msg) {
  const t = document.getElementById('toast');
  t.textContent = msg;
  t.classList.add('show');
  clearTimeout(t._timer);
  t._timer = setTimeout(() => t.classList.remove('show'), 2000);
}

// === SEVERITY FILTER ===
document.getElementById('severity-filter').addEventListener('change', function() {
  STATE.severityFilter = this.value;
  STATE.selectedId = null;
  updateAll();
});

// === INIT ===
init();
</script>
</body>
</html>
